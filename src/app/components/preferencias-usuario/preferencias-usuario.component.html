<div class="preferencias-container">
  <div class="header">
    <h2>‚öôÔ∏è Preferencias de Usuario</h2>
    <p class="subtitle">Configura tus preferencias personales para las notificaciones</p>
  </div>

  <div *ngIf="loading" class="loading-container">
    <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
    <p>Cargando configuraci√≥n...</p>
  </div>

  <div *ngIf="!loading" class="content">
    <mat-tab-group>
      <!-- Tab: Tiempos y Frecuencias -->
      <mat-tab label="‚è∞ Tiempos">
        <div class="tab-content">
          <mat-card class="config-card">
            <mat-card-header>
              <mat-card-title>Configuraci√≥n de Tiempos</mat-card-title>
              <mat-card-subtitle>Define cu√°ndo y con qu√© frecuencia recibir notificaciones</mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div class="form-grid">
                <!-- D√≠as de anticipaci√≥n -->
                <mat-form-field appearance="outline">
                  <mat-label>D√≠as de anticipaci√≥n</mat-label>
                  <mat-select 
                    [value]="configuracion.tiempos.diasAnticipacion"
                    (selectionChange)="actualizarSeccion('tiempos', 'diasAnticipacion', $event.value)">
                    <mat-option *ngFor="let opcion of opcionesAnticipacion" [value]="opcion.valor">
                      {{ opcion.etiqueta }}
                    </mat-option>
                  </mat-select>
                  <mat-hint>Cu√°ntos d√≠as antes del vencimiento enviar la notificaci√≥n</mat-hint>
                </mat-form-field>

                <!-- Hora de notificaci√≥n -->
                <mat-form-field appearance="outline">
                  <mat-label>Hora de notificaci√≥n</mat-label>
                  <mat-select 
                    [value]="configuracion.tiempos.horaNotificacion"
                    (selectionChange)="actualizarSeccion('tiempos', 'horaNotificacion', $event.value)">
                    <mat-option *ngFor="let hora of opcionesHora" [value]="hora">
                      {{ hora }}
                    </mat-option>
                  </mat-select>
                  <mat-hint>Hora del d√≠a para enviar las notificaciones</mat-hint>
                </mat-form-field>

                <!-- Recordatorios -->
                <div class="toggle-field">
                  <mat-slide-toggle 
                    [checked]="configuracion.tiempos.recordatorios"
                    (change)="actualizarSeccion('tiempos', 'recordatorios', $event.checked)">
                    <mat-icon>repeat</mat-icon>
                    Enviar recordatorios
                  </mat-slide-toggle>
                  <p class="field-description">Enviar notificaciones adicionales si no se ha pagado</p>
                </div>

                <!-- Frecuencia de recordatorios -->
                <mat-form-field 
                  appearance="outline" 
                  [class.disabled]="!configuracion.tiempos.recordatorios">
                  <mat-label>Frecuencia de recordatorios</mat-label>
                  <mat-select 
                    [value]="configuracion.tiempos.frecuenciaRecordatorios"
                    [disabled]="!configuracion.tiempos.recordatorios"
                    (selectionChange)="actualizarSeccion('tiempos', 'frecuenciaRecordatorios', $event.value)">
                    <mat-option *ngFor="let opcion of opcionesFrecuencia" [value]="opcion.valor">
                      {{ opcion.etiqueta }}
                    </mat-option>
                  </mat-select>
                  <mat-hint>Con qu√© frecuencia enviar recordatorios</mat-hint>
                </mat-form-field>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Tab: Filtros -->
      <mat-tab label="üîç Filtros">
        <div class="tab-content">
          <mat-card class="config-card">
            <mat-card-header>
              <mat-card-title>Filtros de Notificaci√≥n</mat-card-title>
              <mat-card-subtitle>Define qu√© tarjetas y montos incluir en las notificaciones</mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div class="form-grid">
                <!-- Monto m√≠nimo -->
                <mat-form-field appearance="outline">
                  <mat-label>Monto m√≠nimo</mat-label>
                  <input 
                    matInput 
                    type="number" 
                    min="0" 
                    step="100"
                    [value]="configuracion.filtros.montoMinimo"
                    (input)="actualizarSeccion('filtros', 'montoMinimo', +$any($event.target).value)">
                  <span matPrefix>$&nbsp;</span>
                  <mat-hint>Solo notificar si el monto adeudado supera este valor</mat-hint>
                </mat-form-field>

                <!-- Solo tarjetas activas -->
                <div class="toggle-field">
                  <mat-slide-toggle 
                    [checked]="configuracion.filtros.soloTarjetasActivas"
                    (change)="actualizarSeccion('filtros', 'soloTarjetasActivas', $event.checked)">
                    <mat-icon>credit_card</mat-icon>
                    Solo tarjetas activas
                  </mat-slide-toggle>
                  <p class="field-description">Incluir √∫nicamente tarjetas marcadas como activas</p>
                </div>
              </div>

              <!-- Selecci√≥n de tarjetas -->
              <div class="tarjetas-section">
                <h4>Tarjetas a Monitorear</h4>
                <div class="tarjetas-actions">
                  <button 
                    mat-stroked-button 
                    color="primary" 
                    (click)="seleccionarTodasLasTarjetas()">
                    <mat-icon>select_all</mat-icon>
                    Seleccionar Todas
                  </button>
                  <button 
                    mat-stroked-button 
                    color="warn" 
                    (click)="deseleccionarTodasLasTarjetas()">
                    <mat-icon>deselect</mat-icon>
                    Deseleccionar Todas
                  </button>
                </div>

                <div class="tarjetas-grid">
                  <div 
                    *ngFor="let tarjeta of tarjetas" 
                    class="tarjeta-item"
                    [class.selected]="isTarjetaSeleccionada(tarjeta.id)">
                    <mat-slide-toggle 
                      [checked]="isTarjetaSeleccionada(tarjeta.id)"
                      (change)="onTarjetaSeleccionChange(tarjeta.id, $event.checked)">
                      <div class="tarjeta-info">
                        <span class="tarjeta-nombre">{{ tarjeta.nombre }}</span>
                        <span class="tarjeta-banco">{{ tarjeta.banco }}</span>
                        <span class="tarjeta-limite">L√≠mite: ${{ tarjeta.limite | number:'1.0-0' }}</span>
                      </div>
                    </mat-slide-toggle>
                  </div>
                </div>

                <div class="selection-summary">
                  <mat-chip-set>
                    <mat-chip color="primary" selected>
                      {{ configuracion.filtros.tarjetasSeleccionadas.length }} de {{ tarjetas.length }} tarjetas seleccionadas
                    </mat-chip>
                  </mat-chip-set>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Tab: Preferencias -->
      <mat-tab label="üé® Preferencias">
        <div class="tab-content">
          <mat-card class="config-card">
            <mat-card-header>
              <mat-card-title>Preferencias de Visualizaci√≥n</mat-card-title>
              <mat-card-subtitle>Personaliza c√≥mo se muestran las notificaciones</mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div class="form-grid">
                <!-- Incluir detalles de gastos -->
                <div class="toggle-field">
                  <mat-slide-toggle 
                    [checked]="configuracion.preferencias.incluirDetallesGastos"
                    (change)="actualizarSeccion('preferencias', 'incluirDetallesGastos', $event.checked)">
                    <mat-icon>receipt</mat-icon>
                    Incluir detalles de gastos
                  </mat-slide-toggle>
                  <p class="field-description">Mostrar informaci√≥n detallada de los gastos en las notificaciones</p>
                </div>

                <!-- Incluir recomendaciones -->
                <div class="toggle-field">
                  <mat-slide-toggle 
                    [checked]="configuracion.preferencias.incluirRecomendaciones"
                    (change)="actualizarSeccion('preferencias', 'incluirRecomendaciones', $event.checked)">
                    <mat-icon>lightbulb</mat-icon>
                    Incluir recomendaciones
                  </mat-slide-toggle>
                  <p class="field-description">Agregar sugerencias y consejos financieros en las notificaciones</p>
                </div>

                <!-- Formato de moneda -->
                <mat-form-field appearance="outline">
                  <mat-label>Formato de moneda</mat-label>
                  <mat-select 
                    [value]="configuracion.preferencias.formatoMoneda"
                    (selectionChange)="actualizarSeccion('preferencias', 'formatoMoneda', $event.value)">
                    <mat-option *ngFor="let opcion of opcionesMoneda" [value]="opcion.valor">
                      {{ opcion.etiqueta }}
                    </mat-option>
                  </mat-select>
                  <mat-hint>Moneda para mostrar los montos</mat-hint>
                </mat-form-field>

                <!-- Idioma -->
                <mat-form-field appearance="outline">
                  <mat-label>Idioma</mat-label>
                  <mat-select 
                    [value]="configuracion.preferencias.idioma"
                    (selectionChange)="actualizarSeccion('preferencias', 'idioma', $event.value)">
                    <mat-option *ngFor="let opcion of opcionesIdioma" [value]="opcion.valor">
                      {{ opcion.etiqueta }}
                    </mat-option>
                  </mat-select>
                  <mat-hint>Idioma para las notificaciones</mat-hint>
                </mat-form-field>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Tab: Gesti√≥n -->
      <mat-tab label="üíæ Gesti√≥n">
        <div class="tab-content">
          <mat-card class="config-card">
            <mat-card-header>
              <mat-card-title>Gesti√≥n de Configuraci√≥n</mat-card-title>
              <mat-card-subtitle>Exportar, importar y resetear configuraci√≥n</mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <!-- Estad√≠sticas -->
              <div class="stats-section">
                <h4>Estad√≠sticas de Configuraci√≥n</h4>
                <div class="stats-grid">
                  <div class="stat-item">
                    <mat-icon>notifications</mat-icon>
                    <span class="stat-value">{{ getEstadisticas().canalesHabilitados }}</span>
                    <span class="stat-label">Canales habilitados</span>
                  </div>
                  <div class="stat-item">
                    <mat-icon>credit_card</mat-icon>
                    <span class="stat-value">{{ getEstadisticas().tarjetasMonitoreadas }}</span>
                    <span class="stat-label">Tarjetas monitoreadas</span>
                  </div>
                  <div class="stat-item">
                    <mat-icon>schedule</mat-icon>
                    <span class="stat-value">
                      {{ getEstadisticas().ultimaModificacion ? 
                         (getEstadisticas().ultimaModificacion | date:'short') : 'N/A' }}
                    </span>
                    <span class="stat-label">√öltima modificaci√≥n</span>
                  </div>
                </div>
              </div>

              <!-- Acciones de gesti√≥n -->
              <div class="management-actions">
                <h4>Acciones</h4>
                <div class="actions-grid">
                  <button 
                    mat-raised-button 
                    color="primary" 
                    (click)="exportarConfiguracion()">
                    <mat-icon>download</mat-icon>
                    Exportar Configuraci√≥n
                  </button>

                  <div class="import-section">
                    <input 
                      #fileInput 
                      type="file" 
                      accept=".json" 
                      (change)="importarConfiguracion($event)"
                      style="display: none;">
                    <button 
                      mat-raised-button 
                      color="accent" 
                      (click)="fileInput.click()">
                      <mat-icon>upload</mat-icon>
                      Importar Configuraci√≥n
                    </button>
                  </div>

                  <button 
                    mat-raised-button 
                    color="warn" 
                    (click)="resetearConfiguracion()">
                    <mat-icon>restore</mat-icon>
                    Resetear a Valores por Defecto
                  </button>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
</div>