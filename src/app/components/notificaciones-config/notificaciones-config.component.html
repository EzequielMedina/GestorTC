<div class="notificaciones-config">
  <!-- Loading state -->
  <div *ngIf="loading" class="loading-state">
    <div class="loading-spinner"></div>
    <div class="loading-text">Cargando configuraci√≥n...</div>
  </div>

  <!-- Configuraci√≥n principal -->
  <div *ngIf="!loading && configuracion" class="config-container">
    
    <!-- Header -->
    <div class="config-header">
      <h3 class="config-title">
        <span class="title-icon">üîî</span>
        Configuraci√≥n de Notificaciones
      </h3>
      <p class="config-subtitle">
        Configura cu√°ndo y c√≥mo recibir notificaciones sobre tus tarjetas de cr√©dito
      </p>
    </div>

    <!-- Configuraci√≥n de tipos de notificaci√≥n -->
    <section class="config-section">
      <h4 class="section-title">
        <span class="section-icon">üìã</span>
        Tipos de Notificaciones
      </h4>
      
      <div class="tipos-grid">
        <div 
          *ngFor="let tipo of tiposNotificacion" 
          class="tipo-item"
          [class.tipo-habilitado]="esTipoHabilitado(tipo.valor)"
        >
          <label class="tipo-label">
            <input 
              type="checkbox" 
              [checked]="esTipoHabilitado(tipo.valor)"
              (change)="toggleTipoNotificacion(tipo.valor)"
              class="tipo-checkbox"
            />
            <span class="tipo-texto">{{ tipo.etiqueta }}</span>
          </label>
        </div>
      </div>
    </section>

    <!-- Configuraci√≥n de canales -->
    <section class="config-section">
      <h4 class="section-title">
        <span class="section-icon">üì°</span>
        Canales de Notificaci√≥n
      </h4>
      
      <div class="canales-grid">
        <!-- Notificaciones Push -->
        <div class="canal-item">
          <div class="canal-header">
            <label class="canal-label">
              <input 
                type="checkbox" 
                [checked]="estadoPush.isSubscribed"
                [disabled]="!estadoPush.isSupported || gestionandoPush"
                (change)="gestionarSuscripcionPush()"
                class="canal-checkbox"
              />
              <span class="canal-texto">
                <span class="canal-icon">üîî</span>
                Notificaciones Push
              </span>
            </label>
            
            <div class="canal-status">
              <span 
                class="status-badge"
                [class.status-success]="estadoPush.isSupported"
                [class.status-error]="!estadoPush.isSupported"
              >
                {{ estadoPush.isSupported ? '‚úÖ Soportado' : '‚ùå No soportado' }}
              </span>
              
              <span 
                *ngIf="estadoPush.isSupported"
                class="status-badge"
                [class.status-success]="estadoPush.permission === 'granted'"
                [class.status-warning]="estadoPush.permission === 'default'"
                [class.status-error]="estadoPush.permission === 'denied'"
              >
                {{ estadoPush.permission === 'granted' ? 'üîì Permitido' : 
                   estadoPush.permission === 'denied' ? 'üîí Denegado' : '‚ùì Pendiente' }}
              </span>
              
              <span 
                *ngIf="estadoPush.isSupported"
                class="status-badge"
                [class.status-success]="estadoPush.isServiceWorkerRegistered"
                [class.status-error]="!estadoPush.isServiceWorkerRegistered"
              >
                {{ estadoPush.isServiceWorkerRegistered ? '‚öôÔ∏è SW Activo' : '‚ùå SW Inactivo' }}
              </span>
            </div>
          </div>
          
          <div class="canal-description">
            Recibe notificaciones directamente en tu navegador
          </div>
          
          <div class="canal-actions">
            <button 
              type="button" 
              class="btn btn-secondary btn-sm"
              (click)="solicitarPermisosPush()"
              [disabled]="estadoPush.permission === 'granted' || !estadoPush.isSupported"
            >
              Solicitar Permisos
            </button>
            
            <button 
              type="button" 
              class="btn btn-accent btn-sm"
              (click)="probarPushNotification()"
              [disabled]="!estadoPush.isSubscribed || probandoNotificacion"
            >
              <span *ngIf="probandoNotificacion" class="btn-spinner"></span>
              {{ probandoNotificacion ? 'Enviando...' : 'Probar Push' }}
            </button>
          </div>
        </div>

        <!-- Notificaciones por Email -->
        <div class="canal-item">
          <div class="canal-header">
            <label class="canal-label">
              <input 
                type="checkbox" 
                [(ngModel)]="configuracion.canales.email"
                class="canal-checkbox"
              />
              <span class="canal-texto">
                <span class="canal-icon">üìß</span>
                Notificaciones por Email
              </span>
            </label>
            
            <div class="canal-status">
              <span class="status-badge status-info">
                Simulado
              </span>
            </div>
          </div>
          
          <div class="canal-description">
            Recibe notificaciones por correo electr√≥nico (actualmente simulado)
          </div>
          
          <div *ngIf="configuracion.canales.email" class="canal-config">
            <div class="form-group">
              <label for="emailDestino" class="form-label">Email de destino:</label>
              <input 
                type="email" 
                id="emailDestino"
                [(ngModel)]="configuracion.emailDestino"
                class="form-input"
                placeholder="tu-email@ejemplo.com"
              />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Configuraci√≥n de timing -->
    <section class="config-section">
      <h4 class="section-title">
        <span class="section-icon">‚è∞</span>
        Configuraci√≥n de Tiempo
      </h4>
      
      <div class="timing-grid">
        <div class="timing-item">
          <label for="diasAnticipacion" class="form-label">D√≠as de anticipaci√≥n:</label>
          <select 
            id="diasAnticipacion"
            [(ngModel)]="configuracion.tiempos.diasAnticipacion"
            class="form-select"
          >
            <option *ngFor="let opcion of opcionesDiasAnticipacion" [value]="opcion.valor">
              {{ opcion.etiqueta }}
            </option>
          </select>
          <div class="form-help">
            Cu√°ntos d√≠as antes del vencimiento enviar la notificaci√≥n
          </div>
        </div>
        
        <div class="timing-item">
          <label for="horaNotificacion" class="form-label">Hora de notificaci√≥n:</label>
          <select 
            id="horaNotificacion"
            [(ngModel)]="configuracion.tiempos.horaNotificacion"
            class="form-select"
          >
            <option *ngFor="let opcion of opcionesHorario" [value]="opcion.valor">
              {{ opcion.etiqueta }}
            </option>
          </select>
          <div class="form-help">
            Hora preferida para recibir las notificaciones
          </div>
        </div>
      </div>
    </section>

    <!-- Secci√≥n de testing -->
    <section class="config-section testing-section">
      <h4 class="section-title">
        <span class="section-icon">üß™</span>
        Pruebas y Testing
      </h4>
      
      <div class="testing-grid">
        <div class="test-item">
          <h5 class="test-title">Probar Notificaciones</h5>
          <p class="test-description">
            Env√≠a notificaciones de prueba para verificar la configuraci√≥n
          </p>
          
          <div class="test-form">
            <div class="form-group">
              <label for="tarjetaTest" class="form-label">Tarjeta para prueba:</label>
              <select 
                id="tarjetaTest"
                [(ngModel)]="tarjetaSeleccionadaTest"
                class="form-select"
                [disabled]="tarjetas.length === 0"
              >
                <option value="" disabled>Selecciona una tarjeta</option>
                <option *ngFor="let tarjeta of tarjetas" [value]="tarjeta.id">
                  {{ tarjeta.nombre }} - {{ tarjeta.banco }}
                </option>
              </select>
            </div>
            
            <div class="test-buttons">
              <button 
                type="button"
                class="btn btn-secondary"
                (click)="probarNotificacion()"
                [disabled]="!tarjetaSeleccionadaTest || probandoNotificacion"
              >
                <span *ngIf="probandoNotificacion" class="btn-spinner"></span>
                {{ probandoNotificacion ? 'Enviando...' : 'Probar Todas' }}
              </button>
              
              <button 
                type="button"
                class="btn btn-accent"
                (click)="probarPushNotification()"
                [disabled]="!estadoPush.isSubscribed || probandoNotificacion"
              >
                Probar Solo Push
              </button>
            </div>
          </div>
        </div>
        
        <div class="test-item">
          <h5 class="test-title">Verificaci√≥n Manual</h5>
          <p class="test-description">
            Ejecuta manualmente la verificaci√≥n de vencimientos
          </p>
          
          <button 
            type="button"
            class="btn btn-outline"
            (click)="verificarVencimientosManual()"
          >
            Verificar Ahora
          </button>
        </div>
      </div>
    </section>

    <!-- Estado del servicio -->
    <section class="config-section status-section" *ngIf="estadoServicio">
      <h4 class="section-title">
        <span class="section-icon">üìä</span>
        Estado del Servicio
      </h4>
      
      <div class="status-grid">
        <div class="status-item">
          <div class="status-label">Estado:</div>
          <div class="status-value">
            <span 
              class="status-indicator"
              [class.status-active]="!estadoServicio.verificacionActiva"
              [class.status-busy]="estadoServicio.verificacionActiva"
            ></span>
            {{ estadoServicio.verificacionActiva ? 'Verificando...' : 'Activo' }}
          </div>
        </div>
        
        <div class="status-item">
          <div class="status-label">√öltima verificaci√≥n:</div>
          <div class="status-value">{{ formatearFecha(estadoServicio.ultimaVerificacion) }}</div>
        </div>
        
        <div class="status-item">
          <div class="status-label">Pr√≥xima verificaci√≥n:</div>
          <div class="status-value">{{ formatearFecha(estadoServicio.proximaVerificacion) }}</div>
        </div>
      </div>
      
      <div class="status-actions">
        <button 
          type="button"
          class="btn btn-outline btn-sm"
          (click)="cargarEstadoServicio()"
        >
          Actualizar Estado
        </button>
        
        <button 
          type="button"
          class="btn btn-outline btn-sm"
          (click)="reiniciarServicio()"
        >
          Reiniciar Servicio
        </button>
      </div>
    </section>

    <!-- Acciones principales -->
    <div class="config-actions">
      <button 
        type="button"
        class="btn btn-outline"
        (click)="restaurarConfiguracion()"
        [disabled]="!hayCambiosPendientes() || guardando"
      >
        Cancelar
      </button>
      
      <button 
        type="button"
        class="btn btn-primary"
        (click)="guardarConfiguracion()"
        [disabled]="!hayCambiosPendientes() || guardando"
      >
        <span *ngIf="guardando" class="btn-spinner"></span>
        {{ guardando ? 'Guardando...' : 'Guardar Configuraci√≥n' }}
      </button>
    </div>

    <!-- Indicador de cambios pendientes -->
    <div *ngIf="hayCambiosPendientes()" class="changes-indicator">
      <span class="changes-icon">‚ö†Ô∏è</span>
      Tienes cambios sin guardar
    </div>
  </div>
</div>