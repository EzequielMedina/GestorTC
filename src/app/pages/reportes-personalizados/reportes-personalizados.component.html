<div class="reportes-container">
  <section class="content-card">
    <div class="card-header">
      <h2 class="card-title">
        <mat-icon>assessment</mat-icon>
        Reportes Personalizados
      </h2>
      <button mat-raised-button color="primary" (click)="nuevaConfiguracion()">
        <mat-icon>add</mat-icon>
        Nuevo Reporte
      </button>
    </div>

    <div class="card-content">
      <!-- Lista de configuraciones guardadas -->
      <div class="configuraciones-list" *ngIf="configuraciones.length > 0">
        <mat-card *ngFor="let config of configuraciones" class="config-card">
          <mat-card-header>
            <mat-card-title>{{ config.nombre }}</mat-card-title>
            <mat-card-subtitle *ngIf="config.descripcion">{{ config.descripcion }}</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="config-info">
              <span class="info-item">
                <mat-icon>filter_list</mat-icon>
                Filtros configurados
              </span>
              <span class="info-item">
                <mat-icon>view_column</mat-icon>
                {{ getCantidadColumnasVisibles(config) }} columnas
              </span>
              <span class="info-item" *ngIf="config.agruparPor && config.agruparPor !== 'ninguna'">
                <mat-icon>group_work</mat-icon>
                Agrupar por: {{ config.agruparPor }}
              </span>
            </div>
          </mat-card-content>
          <mat-card-actions>
            <button mat-button color="primary" (click)="generarReporte(config)">
              <mat-icon>play_arrow</mat-icon>
              Generar
            </button>
            <button mat-button (click)="editarConfiguracion(config)">
              <mat-icon>edit</mat-icon>
              Editar
            </button>
            <button mat-button color="warn" (click)="eliminarConfiguracion(config)">
              <mat-icon>delete</mat-icon>
              Eliminar
            </button>
          </mat-card-actions>
        </mat-card>
      </div>

      <div class="empty-state" *ngIf="configuraciones.length === 0">
        <mat-icon class="empty-icon">assessment</mat-icon>
        <p>No hay reportes configurados</p>
        <p class="empty-subtext">Crea tu primer reporte personalizado para comenzar</p>
      </div>
    </div>
  </section>

  <!-- Formulario de configuración -->
  <section class="content-card" *ngIf="mostrarFormulario">
    <div class="card-header">
      <h3 class="card-title">{{ modoEdicion ? 'Editar' : 'Nuevo' }} Reporte</h3>
      <button mat-icon-button (click)="mostrarFormulario = false">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="card-content">
      <form>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nombre del reporte</mat-label>
          <input matInput [(ngModel)]="nombreReporte" name="nombreReporte" required>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Descripción (opcional)</mat-label>
          <textarea matInput [(ngModel)]="descripcionReporte" name="descripcionReporte" rows="3"></textarea>
        </mat-form-field>

        <h4>Filtros</h4>
        <app-filtros-avanzados
          [tarjetas]="tarjetas"
          [categorias]="categorias"
          [filtroActual]="filtros"
          (aplicarFiltros)="onFiltrosCambiados($event)"
        ></app-filtros-avanzados>

        <h4>Columnas</h4>
        <div class="columnas-list">
          <mat-checkbox
            *ngFor="let columna of columnas"
            [(ngModel)]="columna.visible"
            [ngModelOptions]="{standalone: true}"
            (change)="toggleColumna(columna.id)"
          >
            {{ columna.nombre }}
          </mat-checkbox>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Agrupar por</mat-label>
            <mat-select [(ngModel)]="agruparPor" name="agruparPor">
              <mat-option value="ninguna">Ninguna</mat-option>
              <mat-option value="tarjeta">Tarjeta</mat-option>
              <mat-option value="categoria">Categoría</mat-option>
              <mat-option value="mes">Mes</mat-option>
              <mat-option value="etiqueta">Etiqueta</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Ordenar por</mat-label>
            <mat-select [(ngModel)]="ordenarPor" name="ordenarPor">
              <mat-option value="fecha">Fecha</mat-option>
              <mat-option value="monto">Monto</mat-option>
              <mat-option value="descripcion">Descripción</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <mat-checkbox [(ngModel)]="ordenAscendente" name="ordenAscendente">
          Orden ascendente
        </mat-checkbox>

        <div class="opciones-avanzadas">
          <h4>Opciones</h4>
          <mat-checkbox [(ngModel)]="incluirResumen" name="incluirResumen">
            Incluir resumen
          </mat-checkbox>
          <mat-checkbox [(ngModel)]="incluirGraficos" name="incluirGraficos">
            Incluir gráficos
          </mat-checkbox>
          <mat-checkbox [(ngModel)]="incluirNotas" name="incluirNotas">
            Incluir notas
          </mat-checkbox>
        </div>

        <div class="form-actions">
          <button mat-raised-button color="primary" (click)="guardarConfiguracion()">
            Guardar
          </button>
          <button mat-button (click)="mostrarFormulario = false">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </section>

  <!-- Reporte generado -->
  <section class="content-card" *ngIf="reporteGenerado">
    <div class="card-header">
      <h3 class="card-title">{{ configuracionActual?.nombre }}</h3>
      <button mat-raised-button color="primary" (click)="exportarAPDF()">
        <mat-icon>picture_as_pdf</mat-icon>
        Exportar PDF
      </button>
    </div>

    <div class="card-content">
      <div class="resumen-section" *ngIf="incluirResumen && reporteGenerado.resumen">
        <h4>Resumen</h4>
        <div class="resumen-grid">
          <div class="resumen-item">
            <span class="resumen-label">Total:</span>
            <span class="resumen-value">${{ reporteGenerado.resumen.totalGastos | number:'1.0-0' }}</span>
          </div>
          <div class="resumen-item">
            <span class="resumen-label">Cantidad:</span>
            <span class="resumen-value">{{ reporteGenerado.resumen.cantidadGastos }}</span>
          </div>
          <div class="resumen-item">
            <span class="resumen-label">Promedio:</span>
            <span class="resumen-value">${{ reporteGenerado.resumen.promedioGasto | number:'1.0-0' }}</span>
          </div>
          <div class="resumen-item">
            <span class="resumen-label">Máximo:</span>
            <span class="resumen-value">${{ reporteGenerado.resumen.gastoMaximo | number:'1.0-0' }}</span>
          </div>
          <div class="resumen-item">
            <span class="resumen-label">Mínimo:</span>
            <span class="resumen-value">${{ reporteGenerado.resumen.gastoMinimo | number:'1.0-0' }}</span>
          </div>
        </div>
      </div>

      <div class="tabla-section">
        <table mat-table [dataSource]="dataSource" class="reporte-table">
          <ng-container *ngFor="let col of displayedColumns">
            <ng-container [matColumnDef]="col">
              <th mat-header-cell *matHeaderCellDef>{{ getColumnaNombre(col) }}</th>
              <td mat-cell *matCellDef="let row">{{ row[col] }}</td>
            </ng-container>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>
    </div>
  </section>
</div>

