<div class="page">
  <div class="header">
    <h2>üì± Reportes por WhatsApp</h2>
    <p class="subtitle">Genera y env√≠a reportes de gastos mensuales por WhatsApp</p>
  </div>

  <div class="content-container">
    <!-- Formulario de configuraci√≥n -->
    <mat-card class="config-card">
      <mat-card-header>
        <mat-card-title>‚öôÔ∏è Configuraci√≥n del Reporte</mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <form [formGroup]="reporteForm" class="reporte-form">
          <div class="form-row">
            <!-- Selector de mes -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Mes</mat-label>
              <mat-select formControlName="mes">
                <mat-option *ngFor="let mes of meses" [value]="mes.valor">
                  {{ mes.nombre }}
                </mat-option>
              </mat-select>
              <mat-icon matSuffix>calendar_month</mat-icon>
            </mat-form-field>

            <!-- Selector de a√±o -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>A√±o</mat-label>
              <mat-select formControlName="anio">
                <mat-option *ngFor="let anio of anios" [value]="anio">
                  {{ anio }}
                </mat-option>
              </mat-select>
              <mat-icon matSuffix>calendar_today</mat-icon>
            </mat-form-field>
          </div>

          <div class="form-row">
            <!-- Campo de n√∫mero de WhatsApp -->
            <mat-form-field appearance="outline" class="form-field full-width">
              <mat-label>N√∫mero de WhatsApp</mat-label>
              <input matInput 
                     formControlName="numeroWhatsapp" 
                     placeholder="+54 9 11 1234-5678"
                     type="tel">
              <mat-icon matSuffix>phone</mat-icon>
              <mat-hint>Incluya el c√≥digo de pa√≠s (ej: +54 para Argentina)</mat-hint>
              <mat-error *ngIf="reporteForm.get('numeroWhatsapp')?.hasError('required')">
                El n√∫mero de WhatsApp es requerido
              </mat-error>
              <mat-error *ngIf="reporteForm.get('numeroWhatsapp')?.hasError('pattern')">
                Formato de n√∫mero inv√°lido
              </mat-error>
            </mat-form-field>
          </div>
        </form>
      </mat-card-content>

      <mat-card-actions class="card-actions">
        <button mat-raised-button 
                color="primary" 
                [disabled]="!puedeGenerar"
                (click)="generarReporte()">
          <mat-icon>picture_as_pdf</mat-icon>
          <span *ngIf="!generandoPdf">Generar Reporte Completo</span>
          <span *ngIf="generandoPdf">Generando...</span>
          <mat-spinner *ngIf="generandoPdf" diameter="20" class="inline-spinner"></mat-spinner>
        </button>
        
        <button mat-raised-button 
                color="accent" 
                [disabled]="!puedeGenerar || !tieneGastosCompartidos"
                (click)="generarReporteGastosCompartidos()">
          <mat-icon>group</mat-icon>
          <span *ngIf="!generandoPdfCompartidos">Solo Gastos Compartidos</span>
          <span *ngIf="generandoPdfCompartidos">Generando...</span>
          <mat-spinner *ngIf="generandoPdfCompartidos" diameter="20" class="inline-spinner"></mat-spinner>
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- Vista previa del reporte -->
    <mat-card *ngIf="datosReporte" class="preview-card">
      <mat-card-header>
        <mat-card-title>üìã Vista Previa del Reporte</mat-card-title>
        <mat-card-subtitle>{{ mesSeleccionado }} {{ anioSeleccionado }}</mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <div class="reporte-summary">
          <div class="summary-item">
            <span class="label">üí∞ Total del mes:</span>
            <span class="value total">${{ datosReporte.totalGastos.toLocaleString('es-AR', { minimumFractionDigits: 2 }) }}</span>
          </div>
          
          <div class="summary-item">
            <span class="label">üí≥ Tarjetas con gastos:</span>
            <span class="value">{{ datosReporte.gastosPorTarjeta.length }}</span>
          </div>
          
          <div class="summary-item" *ngIf="datosReporte.gastosCompartidos.length > 0">
            <span class="label">üë• Gastos compartidos:</span>
            <span class="value">{{ datosReporte.gastosCompartidos.length }}</span>
          </div>
          
          <div class="summary-item" *ngIf="datosReporte.gastosCompartidos.length > 0">
            <span class="label">üí∏ Total gastos compartidos:</span>
            <span class="value">${{ calcularTotalGastosCompartidos().toLocaleString('es-AR', { minimumFractionDigits: 2 }) }}</span>
          </div>
        </div>

        <!-- Resumen por tarjeta -->
        <div class="tarjetas-summary">
          <h4>üìä Resumen por Tarjeta</h4>
          <div class="tarjeta-item" *ngFor="let tarjeta of datosReporte.gastosPorTarjeta">
            <div class="tarjeta-header">
              <span class="tarjeta-nombre">{{ tarjeta.nombreTarjeta }}</span>
              <span class="tarjeta-total">${{ tarjeta.totalTarjeta.toLocaleString('es-AR', { minimumFractionDigits: 2 }) }}</span>
            </div>
            <div class="gastos-count">{{ tarjeta.gastos.length }} movimiento(s)</div>
          </div>
        </div>

        <!-- Gastos Compartidos Detallados -->
        <div class="gastos-compartidos-section" *ngIf="datosReporte.gastosCompartidos.length > 0">
          <h4>üë• Gastos Compartidos</h4>
          <div class="gastos-compartidos-table">
            <div class="table-header">
              <span class="col-descripcion">Descripci√≥n</span>
              <span class="col-monto">Monto</span>
              <span class="col-cuota">Cuota</span>
              <span class="col-compartido">Compartido con</span>
              <span class="col-porcentaje">% Compartido</span>
              <span class="col-total">Total a pagar</span>
            </div>
            <div class="table-row" *ngFor="let gasto of datosReporte.gastosCompartidos">
              <span class="col-descripcion">{{ gasto.descripcion }}</span>
              <span class="col-monto">${{ gasto.monto.toLocaleString('es-AR', { minimumFractionDigits: 2 }) }}</span>
              <span class="col-cuota">{{ gasto.cuotaInfo || 'Pago √∫nico' }}</span>
              <span class="col-compartido">{{ gasto.compartidoCon }}</span>
              <span class="col-porcentaje">{{ gasto.porcentajeCompartido }}%</span>
              <span class="col-total">${{ (gasto.monto * gasto.porcentajeCompartido / 100).toLocaleString('es-AR', { minimumFractionDigits: 2 }) }}</span>
            </div>
            <div class="table-footer">
              <span class="col-descripcion"><strong>TOTAL GASTOS COMPARTIDOS</strong></span>
              <span class="col-monto"></span>
              <span class="col-cuota"></span>
              <span class="col-compartido"></span>
              <span class="col-porcentaje"></span>
              <span class="col-total"><strong>${{ calcularTotalGastosCompartidos().toLocaleString('es-AR', { minimumFractionDigits: 2 }) }}</strong></span>
            </div>
          </div>
        </div>
      </mat-card-content>

      <mat-card-actions class="card-actions">
        <button mat-raised-button 
                color="accent"
                [disabled]="!pdfBlob"
                (click)="descargarPdf()">
          <mat-icon>download</mat-icon>
          Descargar PDF Completo
        </button>
        
        <button mat-raised-button 
                color="primary"
                [disabled]="!puedeEnviar"
                (click)="enviarPorWhatsapp()">
          <mat-icon>send</mat-icon>
          <span *ngIf="!enviandoWhatsapp">Enviar Completo por WhatsApp</span>
          <span *ngIf="enviandoWhatsapp">Enviando...</span>
          <mat-spinner *ngIf="enviandoWhatsapp" diameter="20" class="inline-spinner"></mat-spinner>
        </button>
        
        <button mat-raised-button 
                color="warn"
                [disabled]="!tieneGastosCompartidos || !reporteForm.valid"
                (click)="enviarGastosCompartidosPorWhatsapp()">
          <mat-icon>group</mat-icon>
          <span *ngIf="!enviandoWhatsapp">Enviar Solo Gastos Compartidos</span>
          <span *ngIf="enviandoWhatsapp">Enviando...</span>
          <mat-spinner *ngIf="enviandoWhatsapp" diameter="20" class="inline-spinner"></mat-spinner>
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- Instrucciones -->
    <mat-card class="instructions-card">
      <mat-card-header>
        <mat-card-title>‚ÑπÔ∏è Instrucciones</mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <ol class="instructions-list">
          <li>Seleccione el <strong>mes y a√±o</strong> del cual desea generar el reporte</li>
          <li>Ingrese el <strong>n√∫mero de WhatsApp</strong> de destino (incluya el c√≥digo de pa√≠s)</li>
          <li>Haga clic en <strong>"Generar Reporte"</strong> para crear el PDF</li>
          <li>Revise la vista previa del reporte generado</li>
          <li>Haga clic en <strong>"Enviar por WhatsApp"</strong> para abrir WhatsApp Web</li>
          <li>El archivo PDF se descargar√° autom√°ticamente para que pueda adjuntarlo manualmente</li>
        </ol>
        
        <div class="note">
          <mat-icon>info</mat-icon>
          <span><strong>Nota:</strong> El reporte incluye todos los movimientos del mes seleccionado, 
          considerando las cuotas que corresponden a ese per√≠odo.</span>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>