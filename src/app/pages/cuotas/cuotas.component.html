<div class="page">
  <div class="header">
    <h2>Gesti√≥n de Cuotas</h2>
    <p class="subtitle">Administra y sigue el estado de tus cuotas pendientes</p>
  </div>

  <!-- Resumen del Mes -->
  <section class="content-card" *ngIf="resumenMes$ | async as resumen">
    <div class="card-header">
      <h3 class="card-title">Resumen del Mes</h3>
      <mat-form-field appearance="outline" class="mes-selector">
        <mat-label>Mes</mat-label>
        <input 
          matInput 
          type="month" 
          [value]="mesSeleccionado"
          (change)="cambiarMes($any($event.target).value)"
        />
      </mat-form-field>
    </div>
    
    <div class="resumen-grid">
      <div class="resumen-item">
        <div class="resumen-icon pendiente">
          <mat-icon>schedule</mat-icon>
        </div>
        <div class="resumen-info">
          <div class="resumen-label">Pendientes</div>
          <div class="resumen-value">${{ resumen.totalPendiente | number:'1.2-2' }}</div>
          <div class="resumen-count">{{ resumen.cantidadPendientes }} cuota{{ resumen.cantidadPendientes !== 1 ? 's' : '' }}</div>
        </div>
      </div>

      <div class="resumen-item">
        <div class="resumen-icon pagada">
          <mat-icon>check_circle</mat-icon>
        </div>
        <div class="resumen-info">
          <div class="resumen-label">Pagadas</div>
          <div class="resumen-value">${{ resumen.totalPagado | number:'1.2-2' }}</div>
          <div class="resumen-count">{{ resumen.cantidadPagadas }} cuota{{ resumen.cantidadPagadas !== 1 ? 's' : '' }}</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Filtros -->
  <section class="content-card">
    <h3 class="card-title">Filtros</h3>
    <div class="filtros-grid">
      <mat-form-field appearance="outline">
        <mat-label>Estado</mat-label>
        <mat-select [(ngModel)]="filtroEstado" (selectionChange)="aplicarFiltros()">
          <mat-option value="TODAS">Todas</mat-option>
          <mat-option value="PENDIENTE">Pendientes</mat-option>
          <mat-option value="PAGADA">Pagadas</mat-option>
          <mat-option value="ADELANTADA">Adelantadas</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" *ngIf="tarjetas$ | async as tarjetas">
        <mat-label>Tarjeta</mat-label>
        <mat-select [(ngModel)]="filtroTarjeta" (selectionChange)="aplicarFiltros()">
          <mat-option value="TODAS">Todas</mat-option>
          <mat-option *ngFor="let tarjeta of tarjetas" [value]="tarjeta.id">
            {{ tarjeta.nombre }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fecha Inicio</mat-label>
        <input matInput [matDatepicker]="pickerInicio" [(ngModel)]="fechaInicio" (dateChange)="aplicarFiltros()">
        <mat-datepicker-toggle matSuffix [for]="pickerInicio"></mat-datepicker-toggle>
        <mat-datepicker #pickerInicio></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fecha Fin</mat-label>
        <input matInput [matDatepicker]="pickerFin" [(ngModel)]="fechaFin" (dateChange)="aplicarFiltros()">
        <mat-datepicker-toggle matSuffix [for]="pickerFin"></mat-datepicker-toggle>
        <mat-datepicker #pickerFin></mat-datepicker>
      </mat-form-field>
    </div>

    <div class="filtros-actions">
      <button mat-stroked-button (click)="limpiarFiltros()">
        <mat-icon>clear</mat-icon>
        Limpiar Filtros
      </button>
    </div>
  </section>

  <!-- Lista de Cuotas -->
  <section class="content-card">
    <div class="card-header">
      <h3 class="card-title">Cuotas ({{ cuotasFiltradas.length }})</h3>
    </div>

    <div *ngIf="cuotasFiltradas.length > 0; else sinCuotas">
      <table mat-table [dataSource]="cuotasFiltradas" class="cuotas-table" *ngIf="gastos$ | async as gastos; else loading">
        <ng-container matColumnDef="numero">
          <th mat-header-cell *matHeaderCellDef>#</th>
          <td mat-cell *matCellDef="let cuota">{{ cuota.numeroCuota }}</td>
        </ng-container>

        <ng-container matColumnDef="gasto">
          <th mat-header-cell *matHeaderCellDef>Gasto</th>
          <td mat-cell *matCellDef="let cuota">{{ getGastoDescripcion(cuota, gastos) }}</td>
        </ng-container>

        <ng-container matColumnDef="tarjeta">
          <th mat-header-cell *matHeaderCellDef>Tarjeta</th>
          <td mat-cell *matCellDef="let cuota">
            <span *ngIf="tarjetas$ | async as tarjetas">{{ getTarjetaNombre(cuota, gastos, tarjetas) }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="fechaVencimiento">
          <th mat-header-cell *matHeaderCellDef>Vencimiento</th>
          <td mat-cell *matCellDef="let cuota">{{ formatearFecha(cuota.fechaVencimiento) }}</td>
        </ng-container>

        <ng-container matColumnDef="monto">
          <th mat-header-cell *matHeaderCellDef>Monto</th>
          <td mat-cell *matCellDef="let cuota">${{ cuota.monto | number:'1.2-2' }}</td>
        </ng-container>

        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let cuota">
            <mat-chip [class]="getEstadoClass(cuota.estado)">
              <mat-icon>{{ getEstadoIcon(cuota.estado) }}</mat-icon>
              {{ cuota.estado }}
            </mat-chip>
          </td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let cuota">
            <button 
              mat-icon-button 
              *ngIf="cuota.estado === 'PENDIENTE'"
              (click)="marcarComoPagada(cuota)"
              matTooltip="Marcar como pagada"
              color="primary"
            >
              <mat-icon>check</mat-icon>
            </button>
            <button 
              mat-icon-button 
              *ngIf="cuota.estado === 'PENDIENTE'"
              (click)="adelantarCuota(cuota)"
              matTooltip="Adelantar cuota"
              color="accent"
            >
              <mat-icon>fast_forward</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>

    <ng-template #sinCuotas>
      <div class="empty-state">
        <mat-icon>event_busy</mat-icon>
        <p>No hay cuotas que coincidan con los filtros seleccionados</p>
      </div>
    </ng-template>

    <ng-template #loading>
      <div class="loading-state">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      </div>
    </ng-template>
  </section>
</div>

