import { Component, signal, ViewChild, OnInit, inject } from '@angular/core';
import { RouterLink, RouterLinkActive, RouterOutlet } from '@angular/router';
import { CommonModule } from '@angular/common';
import { MatToolbarModule } from '@angular/material/toolbar';
import { MatButtonModule } from '@angular/material/button';
import { MatIconModule } from '@angular/material/icon';
import { MatSidenavModule } from '@angular/material/sidenav';
import { MatListModule } from '@angular/material/list';
import { BackgroundSyncService } from './services/background-sync.service';
import { VencimientoService } from './services/vencimiento.service';
import { ConfiguracionUsuarioService } from './services/configuracion-usuario.service';
import { NotificacionService } from './services/notificacion.service';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [
    CommonModule, 
    RouterOutlet,
    RouterLink,
    RouterLinkActive,
    MatToolbarModule,
    MatButtonModule,
    MatIconModule,
    MatSidenavModule,
    MatListModule
  ],
  templateUrl: './app.html',
  styleUrl: './app.css'
})
export class App implements OnInit {
  protected readonly title = signal('Gestor de Cuentas');
  
  private backgroundSyncService = inject(BackgroundSyncService);
  private vencimientoService = inject(VencimientoService);
  private configuracionUsuarioService = inject(ConfiguracionUsuarioService);
  private notificacionService = inject(NotificacionService);

  ngOnInit() {
    this.configurarFuncionesDebug();
  }

  private configurarFuncionesDebug(): void {
    // Exponer servicios para diagn√≥stico
    (window as any).backgroundSyncService = this.backgroundSyncService;
    (window as any).vencimientoService = this.vencimientoService;
    (window as any).configuracionUsuarioService = this.configuracionUsuarioService;
    (window as any).notificacionService = this.notificacionService;
    
    // Funci√≥n para forzar verificaci√≥n desde Service Worker
    (window as any).forzarVerificacionVencimientos = () => {
      console.log('üîß Forzando verificaci√≥n de vencimientos desde Service Worker...');
      this.backgroundSyncService.forzarVerificacionVencimientos();
    };

    // Funci√≥n para verificaci√≥n manual desde la aplicaci√≥n
    (window as any).verificarVencimientosManual = () => {
      console.log('üîß Ejecutando verificaci√≥n manual desde la aplicaci√≥n...');
      this.vencimientoService.verificarVencimientosManual().subscribe({
        next: (resultado) => console.log('‚úÖ Verificaci√≥n completada:', resultado),
        error: (error) => console.error('‚ùå Error en verificaci√≥n:', error)
      });
    };

    // Funci√≥n para verificar configuraci√≥n en Service Worker
    (window as any).verificarConfiguracionSW = async () => {
      console.log('üîç Verificando configuraci√≥n en Service Worker...');
      try {
        const channel = new MessageChannel();
        const response = await new Promise((resolve, reject) => {
          channel.port1.onmessage = (event) => {
            if (event.data.success) {
              resolve(event.data.config);
            } else {
              reject(new Error(event.data.error));
            }
          };
          
          navigator.serviceWorker.controller?.postMessage(
            { type: 'DEBUG_CONFIG' },
            [channel.port2]
          );
          
          setTimeout(() => reject(new Error('Timeout')), 5000);
        });
        
        console.log('üìã Configuraci√≥n en Service Worker (IndexedDB):', response);
        return response;
      } catch (error) {
        console.error('‚ùå Error verificando configuraci√≥n SW:', error);
        return null;
      }
    };

    // Funci√≥n para verificar configuraci√≥n en localStorage
    (window as any).verificarConfiguracionLocal = () => {
      console.log('üîç Configuraci√≥n en localStorage:');
      
      // Verificar gestor-tc-config-usuario
      const configUsuario = localStorage.getItem('gestor-tc-config-usuario');
      if (configUsuario) {
        const config = JSON.parse(configUsuario);
        console.log('üìã gestor-tc-config-usuario:', {
          horaNotificacion: config.horaNotificacion,
          diasAnticipacion: config.diasAnticipacion,
          canales: config.canales,
          emailDestino: config.emailDestino
        });
      } else {
        console.log('‚ùå No se encontr√≥ gestor-tc-config-usuario');
      }
      
      // NUEVO: Verificar gestor-tc-config-notificaciones
      const configNotificaciones = localStorage.getItem('gestor-tc-config-notificaciones');
      if (configNotificaciones) {
        const config = JSON.parse(configNotificaciones);
        console.log('üìã gestor-tc-config-notificaciones:', {
          horaNotificacion: config.horaNotificacion,
          diasAnticipacion: config.diasAnticipacion,
          emailHabilitado: config.emailHabilitado,
          pushHabilitado: config.pushHabilitado,
          emailDestino: config.emailDestino
        });
      } else {
        console.log('‚ùå No se encontr√≥ gestor-tc-config-notificaciones');
      }
      
      // Verificar otros stores relacionados
      const keys = Object.keys(localStorage).filter(key => key.includes('gestor-tc'));
      console.log('üì¶ Todos los stores de gestor-tc:', keys);
    };

    console.log('üîß Funciones de debug disponibles:');
    console.log('- forzarVerificacionVencimientos(): Fuerza verificaci√≥n desde Service Worker');
    console.log('- verificarVencimientosManual(): Ejecuta verificaci√≥n manual desde la aplicaci√≥n');
    console.log('- verificarConfiguracionSW(): Muestra configuraci√≥n guardada en Service Worker');
    console.log('- verificarConfiguracionLocal(): Muestra configuraci√≥n en localStorage');
  }
}
