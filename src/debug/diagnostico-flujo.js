// Script de diagn√≥stico para verificar el flujo actual vs deseado
// Ejecutar en DevTools Console

const DiagnosticoFlujo = {
  // Flujo deseado documentado
  flujoDeseado: {
    pasos: [
      '1. Usuario configura hora de notificaci√≥n en UI',
      '2. ConfiguracionUsuarioService guarda en localStorage',
      '3. BackgroundSyncService detecta cambio y sincroniza con SW',
      '4. SW guarda configuraci√≥n en IndexedDB (store: configuracion)',
      '5. NotificacionService tambi√©n guarda en IndexedDB (store: configuracion-notificaciones)',
      '6. VencimientoService programa verificaciones cada hora',
      '7. SW ejecuta verificarVencimientosOffline() en la hora configurada ¬±5min',
      '8. SW env√≠a notificaciones si hay tarjetas por vencer'
    ],
    stores: {
      localStorage: ['configuracion-usuario'],
      indexedDB: {
        'GestorTCDB': ['configuracion', 'configuracion-notificaciones', 'tarjetas']
      }
    }
  },

  // Verificar estado actual
  async verificarEstadoActual() {
    console.log('üîç DIAGN√ìSTICO DEL FLUJO ACTUAL');
    console.log('================================');
    
    // 1. Verificar localStorage
    await this.verificarLocalStorage();
    
    // 2. Verificar IndexedDB
    await this.verificarIndexedDB();
    
    // 3. Verificar Service Worker
    await this.verificarServiceWorker();
    
    // 4. Verificar Background Sync
    await this.verificarBackgroundSync();
    
    // 5. Verificar configuraci√≥n actual
    await this.verificarConfiguracion();
    
    // 6. Mostrar comparaci√≥n
    this.mostrarComparacion();
  },

  async verificarLocalStorage() {
    console.log('\nüì± VERIFICANDO LOCALSTORAGE:');
    const config = localStorage.getItem('configuracion-usuario');
    if (config) {
      const parsed = JSON.parse(config);
      console.log('‚úÖ Configuraci√≥n encontrada:', parsed);
      console.log('‚è∞ Hora configurada:', parsed.tiempos?.horaNotificacion || 'No definida');
    } else {
      console.log('‚ùå No se encontr√≥ configuraci√≥n en localStorage');
    }
  },

  async verificarIndexedDB() {
    console.log('\nüíæ VERIFICANDO INDEXEDDB:');
    
    try {
      const db = await this.abrirIndexedDB();
      
      // Verificar store 'configuracion'
      const configStore = await this.leerStore(db, 'configuracion');
      console.log('üìä Store "configuracion":', configStore);
      
      // Verificar store 'configuracion-notificaciones'
      const notifStore = await this.leerStore(db, 'configuracion-notificaciones');
      console.log('üîî Store "configuracion-notificaciones":', notifStore);
      
      // Verificar store 'tarjetas'
      const tarjetasStore = await this.leerStore(db, 'tarjetas');
      console.log('üí≥ Store "tarjetas":', tarjetasStore?.length || 0, 'tarjetas');
      
      db.close();
    } catch (error) {
      console.log('‚ùå Error accediendo a IndexedDB:', error);
    }
  },

  async abrirIndexedDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('GestorTCDB', 4);
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  },

  async leerStore(db, storeName) {
    return new Promise((resolve, reject) => {
      try {
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.getAll();
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      } catch (error) {
        console.log(`‚ö†Ô∏è Store "${storeName}" no existe`);
        resolve(null);
      }
    });
  },

  async verificarServiceWorker() {
    console.log('\nüîß VERIFICANDO SERVICE WORKER:');
    
    if ('serviceWorker' in navigator) {
      const registration = await navigator.serviceWorker.getRegistration();
      if (registration) {
        console.log('‚úÖ Service Worker registrado:', registration.active?.state);
        
        // Verificar si hay funciones de debug disponibles
        if (window.verificarConfiguracionSW) {
          console.log('üîç Ejecutando verificarConfiguracionSW()...');
          window.verificarConfiguracionSW();
        } else {
          console.log('‚ö†Ô∏è Funci√≥n verificarConfiguracionSW() no disponible');
        }
      } else {
        console.log('‚ùå Service Worker no registrado');
      }
    } else {
      console.log('‚ùå Service Worker no soportado');
    }
  },

  async verificarBackgroundSync() {
    console.log('\nüîÑ VERIFICANDO BACKGROUND SYNC:');
    
    if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
      console.log('‚úÖ Background Sync soportado');
      
      // Verificar √∫ltima sincronizaci√≥n
      const ultimaSync = localStorage.getItem('ultima-sincronizacion');
      if (ultimaSync) {
        const fecha = new Date(ultimaSync);
        console.log('üìÖ √öltima sincronizaci√≥n:', fecha.toLocaleString());
        console.log('‚è±Ô∏è Hace:', Math.round((Date.now() - fecha.getTime()) / 60000), 'minutos');
      } else {
        console.log('‚ö†Ô∏è No hay registro de sincronizaci√≥n');
      }
    } else {
      console.log('‚ùå Background Sync no soportado');
    }
  },

  async verificarConfiguracion() {
    console.log('\n‚öôÔ∏è VERIFICANDO CONFIGURACI√ìN ACTUAL:');
    
    // Verificar hora actual vs configurada
    const ahora = new Date();
    const horaActual = ahora.getHours().toString().padStart(2, '0') + ':' + 
                     ahora.getMinutes().toString().padStart(2, '0');
    
    console.log('üïê Hora actual:', horaActual);
    
    // Obtener configuraci√≥n desde localStorage
    const config = localStorage.getItem('configuracion-usuario');
    if (config) {
      const parsed = JSON.parse(config);
      const horaConfig = parsed.tiempos?.horaNotificacion;
      console.log('‚è∞ Hora configurada:', horaConfig);
      
      if (horaConfig) {
        const diferencia = this.calcularDiferenciaMinutos(horaActual, horaConfig);
        console.log('üìä Diferencia:', diferencia, 'minutos');
        console.log('‚úÖ Dentro de ventana (¬±5min):', Math.abs(diferencia) <= 5 ? 'S√ç' : 'NO');
      }
    }
  },

  calcularDiferenciaMinutos(hora1, hora2) {
    const [h1, m1] = hora1.split(':').map(Number);
    const [h2, m2] = hora2.split(':').map(Number);
    
    const minutos1 = h1 * 60 + m1;
    const minutos2 = h2 * 60 + m2;
    
    return minutos1 - minutos2;
  },

  mostrarComparacion() {
    console.log('\nüìã COMPARACI√ìN FLUJO DESEADO VS ACTUAL:');
    console.log('=====================================');
    
    console.log('\nüéØ FLUJO DESEADO:');
    this.flujoDeseado.pasos.forEach(paso => console.log(paso));
    
    console.log('\nüîç PROBLEMAS IDENTIFICADOS:');
    console.log('1. Verificar si IndexedDB se est√° creando correctamente');
    console.log('2. Verificar si la sincronizaci√≥n entre stores funciona');
    console.log('3. Verificar si Background Sync se ejecuta cada hora');
    console.log('4. Verificar si esHoraCorrecta() valida correctamente');
    
    console.log('\nüõ†Ô∏è ACCIONES RECOMENDADAS:');
    console.log('1. Ejecutar: forzarSincronizacion() para probar sync manual');
    console.log('2. Ejecutar: forzarVerificacionVencimientos() para probar verificaci√≥n');
    console.log('3. Revisar DevTools > Application > Storage para ver IndexedDB');
    console.log('4. Revisar DevTools > Application > Service Workers para ver logs');
  },

  // Funci√≥n para forzar sincronizaci√≥n manual
  async forzarSincronizacion() {
    console.log('üîÑ Forzando sincronizaci√≥n manual...');
    
    if (window.backgroundSyncService) {
      await window.backgroundSyncService.sincronizarManualmente();
      console.log('‚úÖ Sincronizaci√≥n manual ejecutada');
    } else {
      console.log('‚ùå BackgroundSyncService no disponible en window');
    }
  },

  // Funci√≥n para forzar verificaci√≥n de vencimientos
  async forzarVerificacionVencimientos() {
    console.log('üîç Forzando verificaci√≥n de vencimientos...');
    
    if (window.forzarVerificacionVencimientos) {
      await window.forzarVerificacionVencimientos();
      console.log('‚úÖ Verificaci√≥n de vencimientos ejecutada');
    } else {
      console.log('‚ùå Funci√≥n forzarVerificacionVencimientos() no disponible');
    }
  }
};

// Ejecutar diagn√≥stico autom√°ticamente
console.log('üöÄ Iniciando diagn√≥stico del flujo...');
DiagnosticoFlujo.verificarEstadoActual();

// Exponer funciones globalmente para uso manual
window.DiagnosticoFlujo = DiagnosticoFlujo;
window.diagnosticarFlujo = () => DiagnosticoFlujo.verificarEstadoActual();
window.forzarSync = () => DiagnosticoFlujo.forzarSincronizacion();
window.forzarVerif = () => DiagnosticoFlujo.forzarVerificacionVencimientos();

console.log('\nüìù FUNCIONES DISPONIBLES:');
console.log('- diagnosticarFlujo() - Ejecutar diagn√≥stico completo');
console.log('- forzarSync() - Forzar sincronizaci√≥n manual');
console.log('- forzarVerif() - Forzar verificaci√≥n de vencimientos');
console.log('- DiagnosticoFlujo.* - Acceso a todas las funciones del diagn√≥stico');