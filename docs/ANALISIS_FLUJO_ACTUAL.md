# An√°lisis del Flujo Actual vs Deseado

## üéØ Flujo Deseado

### 1. Configuraci√≥n de Notificaciones
```
Usuario configura hora ‚Üí ConfiguracionUsuarioService (localStorage) ‚Üí 
BackgroundSyncService detecta cambio ‚Üí Sincroniza con SW ‚Üí 
SW guarda en IndexedDB ‚Üí NotificacionService tambi√©n guarda en IndexedDB
```

### 2. Ejecuci√≥n de Verificaciones
```
VencimientoService programa verificaciones cada hora ‚Üí 
SW ejecuta verificarVencimientosOffline() ‚Üí 
SW valida hora con esHoraCorrecta() ‚Üí 
SW env√≠a notificaciones si hay tarjetas por vencer
```

### 3. Stores Esperados
- **localStorage**: `gestor-tc-config-usuario`, `gestor-tc-config-notificaciones`
- **IndexedDB**: `configuracion`, `configuracion-notificaciones`, `tarjetas`

## üîç Problemas Identificados

### 1. IndexedDB No Se Ve
**Problema**: No aparece la base de datos `gestor-tc-db` en DevTools

**Posibles Causas**:
- IndexedDB no se est√° creando correctamente
- Los datos no se est√°n guardando
- Nombre de base de datos incorrecto

**Verificaci√≥n**:
```javascript
// Ejecutar en DevTools Console
DiagnosticoFlujo.verificarIndexedDB();
```

### 2. Horas No Se Actualizan
**Problema**: Cambios en la configuraci√≥n de hora no se reflejan en el SW

**Posibles Causas**:
- Sincronizaci√≥n entre localStorage e IndexedDB no funciona
- BackgroundSyncService no detecta cambios
- SW no recibe los datos actualizados

**Verificaci√≥n**:
```javascript
// Verificar configuraci√≥n actual
verificarConfiguracionLocal();
verificarConfiguracionSW();
```

### 3. No Se Ejecutan Verificaciones
**Problema**: Las verificaciones autom√°ticas no se disparan

**Posibles Causas**:
- Background Sync no se registra correctamente
- VencimientoService no programa verificaciones
- SW no responde a eventos sync
- Validaci√≥n de hora falla

## üõ†Ô∏è Diagn√≥stico Paso a Paso

### Paso 1: Verificar Estado Actual
```javascript
// Ejecutar en DevTools Console
diagnosticarFlujo();
```

### Paso 2: Verificar Stores
```javascript
// Verificar localStorage
verificarConfiguracionLocal();

// Verificar IndexedDB
DiagnosticoFlujo.verificarIndexedDB();
```

### Paso 3: Probar Sincronizaci√≥n Manual
```javascript
// Forzar sincronizaci√≥n
forzarSync();

// Verificar despu√©s de sincronizaci√≥n
verificarConfiguracionSW();
```

### Paso 4: Probar Verificaci√≥n Manual
```javascript
// Forzar verificaci√≥n
forzarVerif();

// O desde la aplicaci√≥n
verificarVencimientosManual();
```

## üîß Flujo de Sincronizaci√≥n Actual

### ConfiguracionUsuarioService
- Guarda en `localStorage` con clave `gestor-tc-config-usuario`
- Estructura: `{ tiempos: { horaNotificacion }, canales: { email, push } }`

### NotificacionService
- Guarda en `localStorage` con clave `gestor-tc-config-notificaciones`
- Estructura: `{ horaNotificacion, emailHabilitado, pushHabilitado }`

### BackgroundSyncService
- Suscrito a cambios de ambos servicios
- Env√≠a datos al SW via `postMessage`
- SW guarda en IndexedDB

### Service Worker
- Recibe datos via mensaje `SAVE_DATA`
- Guarda en stores `configuracion` y `configuracion-notificaciones`
- Funci√≥n `obtenerConfiguracionDesdeCache()` lee con fallback

## üö® Puntos Cr√≠ticos a Verificar

### 1. Registro del Service Worker
```javascript
// Verificar si SW est√° activo
navigator.serviceWorker.getRegistration().then(reg => {
  console.log('SW State:', reg?.active?.state);
});
```

### 2. Background Sync Support
```javascript
// Verificar soporte
console.log('Background Sync:', 'sync' in window.ServiceWorkerRegistration.prototype);
```

### 3. IndexedDB Creation
```javascript
// Verificar creaci√≥n manual
const request = indexedDB.open('gestor-tc-db');
request.onsuccess = () => console.log('IndexedDB OK');
request.onerror = (e) => console.error('IndexedDB Error:', e);
```

### 4. Validaci√≥n de Hora
```javascript
// Probar funci√≥n esHoraCorrecta
// En SW Console (si est√° disponible)
esHoraCorrecta('14:30'); // Cambiar por hora actual ¬±5min
```

## üìã Checklist de Verificaci√≥n

- [ ] Service Worker registrado y activo
- [ ] IndexedDB `gestor-tc-db` visible en DevTools
- [ ] Stores `configuracion` y `configuracion-notificaciones` con datos
- [ ] localStorage con ambas configuraciones
- [ ] Sincronizaci√≥n autom√°tica funcionando
- [ ] Background Sync registr√°ndose cada hora
- [ ] Funci√≥n `esHoraCorrecta()` validando correctamente
- [ ] Notificaciones de prueba funcionando

## üéØ Pr√≥ximos Pasos

1. **Ejecutar diagn√≥stico completo**
2. **Identificar punto de falla espec√≠fico**
3. **Corregir problema de sincronizaci√≥n**
4. **Probar flujo completo**
5. **Documentar soluci√≥n**

---

**Nota**: Usar las funciones de diagn√≥stico incluidas en `diagnostico-flujo.js` para una verificaci√≥n sistem√°tica.